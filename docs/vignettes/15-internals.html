<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>15 - Internals ‚Ä¢ cpp4r</title><link rel="stylesheet" href="../menu.css"><link rel="stylesheet" href="../content.css"><!-- MathJax Configuration --><script>
    window.MathJax = {
      tex: {
        inlineMath: [['\\(', '\\)'], ['$', '$']],
        displayMath: [['\\[', '\\]'], ['$$', '$$']],
        processEscapes: true,
        processEnvironments: true,
        packages: {'[+]': ['ams', 'newcommand', 'configmacros']}
      },
      options: {
        ignoreHtmlClass: 'tex2jax_ignore',
        processHtmlClass: 'tex2jax_process'
      }
    };
  </script><script id="MathJax-script" async src="../js/tex-svg.js"></script></head><body>
<div class="main-container">
<div id="menu">
  <div>
    <img src="../man/figures/logo.svg" align="center" height="139" alt="cpp4r logo"></div>

  <div class="search-container">
    <input type="text" id="search-box" placeholder="Search..."></div>

  <div class="search-container">
    <button id="theme-toggle" title="Toggle dark mode" aria-label="Toggle dark mode">Toggle theme</button>
    <button id="font-decrease" title="Decrease font size" aria-label="Decrease font size">A-</button>
    <button id="font-increase" title="Increase font size" aria-label="Increase font size">A+</button>
  </div>

  <div class="submenu">
    <label style="border-bottom: 0;"><a style="padding-left: 0;" href="../index.html">Home üè†</a></label>
  </div>

  <div class="submenu">
    <label>Functions</label>
    <a href="../reference/register.html">register</a>
    <a href="../reference/pkg_template.html">pkg_template</a>
    <a href="../reference/unvendor.html">unvendor</a>
    <a href="../reference/vendor.html">vendor</a>
  </div>

  <div class="submenu">
    <label>Vignettes</label>
    <a href="../vignettes/01-intro.html">01 - Introduction</a>
    <a href="../vignettes/02-setup.html">02 - Setup</a>
    <a href="../vignettes/03-package-skeleton.html">03 - Package Skeleton</a>
    <a href="../vignettes/04-read-only.html">04 - Read-only versus Writable R Objects</a>
    <a href="../vignettes/05-logical-functions.html">05 - Logical Functions</a>
    <a href="../vignettes/06-rolling-functions.html">06 - Rolling Functions</a>
    <a href="../vignettes/07-statistical-functions.html">07 - Statistical Functions</a>
    <a href="../vignettes/08-logical-functions-2.html">08 - Logical Functions with Missing Values</a>
    <a href="../vignettes/09-rolling-functions-2.html">09 - Rolling Functions with Missing Values</a>
    <a href="../vignettes/10-statistical-functions-2.html">10 - Statistical Functions with Missing Values</a>
    <a href="../vignettes/11-debugging.html">11 - Debugging R Packages</a>
    <a href="../vignettes/12-external-pointers.html">12 - External Pointers</a>
    <a href="../vignettes/13-compiler-optimization.html">13 - Compiler Optimizations</a>
    <a href="../vignettes/14-linear-algebra.html">14 - Linear Algebra</a>
    <a href="../vignettes/15-internals.html">15 - Internals</a>
    <a href="../vignettes/16-FAQ.html">17 - FAQs</a>
    <a href="../vignettes/17-worked-examples.html">16 - Worked Examples</a>
  </div>

  <div class="submenu">
    <label>News</label>
    <a href="../news/index.html">Changelog</a>
  </div>
</div>
<div id="content">
<div class="content-wrapper">
        <div class="content-main">
          <h1>15 - Internals</h1>



<div id="initial-setup-and-dev-workflow" class="section level2">
<h2>Initial setup and dev workflow</h2>
<p>The development repository for cpp4r is <a href="https://github.com/pachadotdev/cpp4r" class="uri">https://github.com/pachadotdev/cpp4r</a>.</p>
<p>First install any dependencies needed for development.</p>
<pre class="r"><code>install.packages("remotes")
remotes::install_deps(dependencies = TRUE)</code></pre>
<p>You can load the package in an interactive R session</p>
<pre class="r"><code>devtools::load_all()</code></pre>
<p>Or run the cpp4r tests with</p>
<pre class="r"><code>devtools::test()</code></pre>
<p>There are more extensive tests in the <code>cpp4rtest</code>
directory. Generally when developing the C++ headers, you can run R with
your working directory in the <code>cpp4rtest</code> directory and use
<code>devtools::test()</code> to run the cpp4rtests.</p>
<p>If you change the cpp4r headers, you will need to install the new
version of cpp4r and then clean and recompile the cpp4rtest package:</p>
<pre class="r"><code># Assuming that your working directory is `cpp4rtest/`
devtools::clean_dll()
devtools::load_all()</code></pre>
<p>To calculate code coverage of the cpp4r package run the following
from the <code>cpp4r</code> root directory.</p>
<pre class="r"><code>covr::report(cpp4r_coverage())</code></pre>
</div>
<div id="code-formatting" class="section level2">
<h2>Code formatting</h2>
<p>This project uses <a href="https://clang.llvm.org/docs/ClangFormat.html">clang-format</a>
(version 18) to automatically format the C++ code.</p>
<p>You can run <code>make format</code> to re-format all code in the
project. If your system does not have <code>clang-format</code> version
18, you can install it from <a href="https://github.com/pachadotdev/clang-format" class="uri">https://github.com/pachadotdev/clang-format</a>.</p>
<p>Alternatively many IDEs support automatically running
<code>clang-format</code> every time files are written.</p>
</div>
<div id="code-organization" class="section level2">
<h2>Code organization</h2>
<p>cpp4r is a header only library, so all source code exposed to users
lives in <a href="https://github.com/pachadotdev/cpp4r/tree/main/inst/include">inst/include</a>.
R code used to register functions and for
<code>cpp4r::cpp_source()</code> is in <a href="https://github.com/pachadotdev/cpp4r/tree/main/R">R/</a>. Tests
for <em>only</em> the code in <code>R/</code> is in <a href="https://github.com/pachadotdev/cpp4r/tree/main/tests/testthat">tests/testthat/</a>.
The rest of the code is in a separate <a href="https://github.com/pachadotdev/cpp4r/tree/main/cpp4rtest">cpp4rtest/</a>
package included in the source tree. Inside <a href="https://github.com/pachadotdev/cpp4r/tree/main/cpp4rtest/src">cpp4rtest/src</a>
the files that start with <code>test-</code> are C++ tests using the <a href="https://testthat.r-lib.org/reference/use_catch.html">Catch</a>
support in testthat. In addition there are some regular R tests in <a href="https://github.com/pachadotdev/cpp4r/tree/main/cpp4rtest/tests/testthat">cpp4rtest/tests/testthat/</a>.</p>
</div>
<div id="naming-conventions" class="section level2">
<h2>Naming conventions</h2>
<ul><li>All header files are named with a <code>.hpp</code> extension.</li>
<li>All source files are named with a <code>.cpp</code> extension.</li>
<li>Public header files should be put in
<code>inst/include/cpp4r</code></li>
<li>Read only r_vector classes and free functions should be put in the
<code>cpp4r</code> namespace.</li>
<li>Writable r_vector class should be put in the
<code>cpp4r::writable</code> namespace.</li>
<li>Private classes and functions should be put in the
<code>cpp4r::internal</code> namespace.</li>
</ul></div>
<div id="vector-classes" class="section level2">
<h2>Vector classes</h2>
<p>All of the basic r_vector classes are class templates, the base
template is defined in <a href="https://github.com/pachadotdev/cpp4r/blob/main/inst/include/cpp4r/r_vector.hpp">cpp4r/r_vector.hpp</a>.
The template parameter is the type of <strong>value</strong> the
particular R vector stores, e.g.¬†<code>double</code> for
<code>cpp4r::doubles</code>. This differs from Rcpp, whose first
template parameter is the R vector type, e.g. <code>REALSXP</code>.</p>
<p>The file first has the class declarations, then function definitions
further down in the file. Specializations for the various types are in
separate files, e.g.¬†<a href="https://github.com/pachadotdev/cpp4r/blob/main/inst/include/cpp4r/doubles.hpp">cpp4r/doubles.hpp</a>,
<a href="https://github.com/pachadotdev/cpp4r/blob/main/inst/include/cpp4r/integers.hpp">cpp4r/integers.hpp</a></p>
</div>
<div id="coercion-functions" class="section level2">
<h2>Coercion functions</h2>
<p>There are two different coercion functions</p>
<p><code>as_sexp()</code> takes a C++ object and coerces it to a SEXP
object, so it can be used in R. <code>as_cpp&lt;&gt;()</code> is a
template function that takes a SEXP and creates a C++ object from it</p>
<p>The various methods for both functions are defined in <a href="https://github.com/pachadotdev/cpp4r/blob/main/inst/include/cpp4r/as.hpp">cpp4r/as.hpp</a></p>
<p>This is definitely the most complex part of the cpp4r code, with
extensive use of <a href="https://en.wikipedia.org/wiki/Template_metaprogramming">template
metaprogramming</a>. In particular the <a href="https://en.wikipedia.org/wiki/Substitution_failure_is_not_an_error">substitution
failure is not an error (SFINAE)</a> technique is used to control
overloading of the functions. If you could use C++20, a lot of this code
would be made simpler with <a href="https://en.cppreference.com/w/cpp/language/constraints.html">Concepts</a>,
but alas.</p>
<p>The most common C++ types are included in the test suite and should
work without issues, as more exotic types are used in real projects
additional issues may arise.</p>
<p>Some useful links on SFINAE</p>
<ul><li><a href="https://www.fluentcpp.com/2018/05/15/make-sfinae-pretty-1-what-value-sfinae-brings-to-code/" class="uri">https://www.fluentcpp.com/2018/05/15/make-sfinae-pretty-1-what-value-sfinae-brings-to-code/</a>,
<a href="https://www.fluentcpp.com/2018/05/18/make-sfinae-pretty-2-hidden-beauty-sfinae/" class="uri">https://www.fluentcpp.com/2018/05/18/make-sfinae-pretty-2-hidden-beauty-sfinae/</a></li>
</ul></div>
<div id="protection" class="section level2">
<h2>Protection</h2>
<div id="protect-list" class="section level3">
<h3>Protect list</h3>
<p>cpp4r uses an idea proposed by <a href="https://github.com/RcppCore/Rcpp/issues/1081#issuecomment-630330838">Luke
Tierney</a> to use a double linked list with the head preserved to
protect objects cpp4r is protecting.</p>
<p>Each node in the list uses the head (<code>CAR</code>) part to point
to the previous node, and the <code>CDR</code> part to point to the next
node. The <code>TAG</code> is used to point to the object being
protected. The head and tail of the list have <code>R_NilValue</code> as
their <code>CAR</code> and <code>CDR</code> pointers respectively.</p>
<p>Calling <code>cpp4r::detail::store::insert()</code> with a regular R
object will add a new node to the list and return a protect token
corresponding to the node added. Calling
<code>cpp4r::detail::store::release()</code> on this returned token will
release the protection by unlinking the node from the linked list. These
two functions are considered internal to cpp4r, so do not use them in
your packages.</p>
<p>This scheme scales in O(1) time to release or insert an object vs
O(N) or worse time with <code>R_PreserveObject()</code> /
<code>R_ReleaseObject()</code>.</p>
<p>Each package has its own unique protection list, which avoids the
need to manage a ‚Äúglobal‚Äù protection list shared across packages. A
previous version of cpp4r used a global protection list stored in an R
global option, but this caused <a href="https://github.com/r-lib/cpp11/issues/330">multiple
issues</a>.</p>
<p>These functions are defined in <a href="https://github.com/pachadotdev/cpp4r/blob/main/inst/include/cpp4r/protect.hpp">protect.hpp</a>.</p>
</div>
<div id="unwind-protect" class="section level3">
<h3>Unwind Protect</h3>
<p>cpp4r uses <code>R_UnwindProtect()</code> to protect (most) calls to
the R API that could fail. These are usually those that allocate memory,
though in truth most R API functions could error along some paths. If an
error happens under <code>R_UnwindProtect()</code>, cpp4r will throw a
C++ exception. This exception is caught by the try/catch block defined
in the <code>BEGIN_CPP4R</code> macro in <a href="https://github.com/pachadotdev/cpp4r/blob/main/inst/include/cpp4r/declarations.hpp">cpp4r/declarations.hpp</a>.
The exception will cause any C++ destructors to run, freeing any
resources held by C++ objects. After the try/catch block exits, the R
error unwinding is then continued by <code>R_ContinueUnwind()</code> and
a normal R error results.</p>
<p>R &gt;=3.5 is required to use cpp4r, but when it was created, the
goal was to support back to R 3.3, but <code>R_ContinueUnwind()</code>
was not available until R 3.5. Below are a few other options that were
considered to support older R versions:</p>
<ol style="list-style-type: decimal"><li>Using <code>R_TopLevelExec()</code> works to avoid the C long jump,
but because the code is always run in a top level context any errors or
messages thrown cannot be caught by <code>tryCatch()</code> or similar
techniques.</li>
<li>Using <code>R_TryCatch()</code> is not available prior to R 3.4, and
also has a serious bug in R 3.4 (fixed in R 3.5).</li>
<li>Calling the R level <code>tryCatch()</code> function which contains
an expression that runs a C function which then runs the C++ code would
be an option, but implementing this is convoluted and it would impact
performance, perhaps severely.</li>
<li>Have <code>cpp4r::unwind_protect()</code> be a no-op for these
versions. This means any resources held by C++ objects would leak,
including <code>cpp4r::r_vector</code> / <code>cpp4r::sexp</code>
objects.</li>
</ol><p>None of these options were perfect. Here are some pros and cons for
each:</p>
<ol style="list-style-type: decimal"><li>Causes behavior changes and test failures, so it was ruled out.</li>
<li>Was also ruled out since we wanted to support back to R 3.3.</li>
<li>Was ruled out partially because the implementation would be somewhat
tricky and more because performance would suffer greatly.</li>
<li>Is what was ended up being done before requiring R 3.5. It leaked
protected objects when there were R API errors.</li>
</ol></div>
</div>
        </div>
        <footer><p id="last-updated">Loading...</p>
</footer><script src="../js/footer.js"></script><script src="../js/theme.js"></script><script src="../js/search.js"></script><script src="../js/fontsize.js"></script></div>
</div>
</div>
</body></html>

